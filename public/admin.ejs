<!doctype html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <style>
        html,
        body {
            height: 100%;
        }
    </style>


    <title>Admin</title>
</head>

<body>
    <header class="text-center bg-dark text-light p-3">
        <h1>Admin</h1>
    </header>

    <main class="container">

        <div class="row">
            <div class="col text-center">
                <div class="btn-group m-3">
                    <a class="btn btn-danger" href="/logout">logout</a>
                    <a class="btn btn-primary" href="/">home</a>
                </div>


                <h3>edit users</3h>

            </div>
        </div>


        <div class="row justify-content-center">
            <div class="col-lg-6 col-md-8">
                <div class="justify-content-center" id="alert"></div>
            </div>
        </div>




        <div class="row justify-content-center">

            <div class="col">

                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Name</th>
                            <th scope="col">Names</th>
                            <th scope="col">Value</th>
                            <th scope="col">Delete</th>
                        </tr>
                    </thead>
                    <tbody id="table">
                        <!-- <tr>
                            <th scope="row">1</th>
                            <td contenteditable="true">Mark</td>
                            <td>Otto</td>
                            <td>@mdo</td>
                        </tr> -->

                        <% people.forEach(function(p, i){ %>

                            <tr>
                                <th>
                                    <%- i + 1 %>
                                </th>
                                <td contenteditable="true">
                                    <%- p.name %>
                                </td>
                                <td contenteditable="true">
                                    <%- p.names %>
                                </td>
                                <td contenteditable="true">
                                    <%- p.value %>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-danger"
                                        onclick="deleteRow(<%- i %>)">Delete</button>
                                </td>
                            </tr>

                            <% }); %>

                    </tbody>
                </table>
            </div>
        </div>

        <div class="row">
            <div class="col text-center">
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" onclick="addRow()">Add Row</button>
                    <button type="button" class="btn btn-danger" onclick="location.reload()">Cancel</button>
                    <button type="button" class="btn btn-success" onclick="getTable()">Save</button>
                </div>
            </div>
        </div>

        <div class="pb-3"></div>

    </main>

    <script>

        var t = document.getElementById('table')

        function addRow() {
            let row = t.insertRow()

            let idCell = document.createElement('th');
            let name = document.createElement('td');
            let names = document.createElement('td');
            let value = document.createElement('td');
            let del = document.createElement('td');

            name.setAttribute('contenteditable', 'true')
            names.setAttribute('contenteditable', 'true')
            value.setAttribute('contenteditable', 'true')

            let id = t.rows.length - 1

            idCell.innerHTML = id + 1;
            del.innerHTML = `<button type="button" class="btn btn-danger"onclick = "deleteRow(${id})" > Delete</button>`

            row.append(idCell)
            row.append(name)
            row.append(names)
            row.append(value)
            row.append(del)

            updateRows()
        }

        function deleteRow(row) {
            t.deleteRow(row)
            updateRows()
        }

        function updateRows() {
            for (let i = 0; i < t.rows.length; i++) {
                t.rows[i].cells[0].innerText = i + 1
            }
        }

        function getTable() {

            var tableData = []

            for (let i = 0; i < t.rows.length; i++) {

                let row = {
                    name: t.rows[i].cells[1].innerText.replace('\n', ''),
                    names: t.rows[i].cells[2].innerText.replace('\n', '').split(','),
                    value: t.rows[i].cells[3].innerText.replace('\n', '')
                }

                tableData.push(row)

            }
            console.log(tableData);

            fetch('/admin-edit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(tableData)
            })
                .then(res => res.json())
                .then(data => {
                    console.log(data)

                    var alertBox = `
                        <div class="alert alert-${data.type} alert-dismissible fade show" role="alert">
                            ${data.message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>`

                    document.getElementById('alert').innerHTML = alertBox

                })
                .catch(error => {
                    console.log(error)

                    var alertBox = `
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            ${error}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>`

                    document.getElementById('alert').innerHTML = alertBox
                })
        }

    </script>


</body>

</html>